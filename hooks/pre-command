#!/bin/bash
set -euo pipefail

if [[ "${BUILDKITE_PLUGIN_ARTIFACTS_DEBUG:-false}" =~ (true|on|1) ]] ; then
  echo "~~~ :hammer: Enabling debug mode"
  set -x
fi

args=("download")

if [[ -n "${BUILDKITE_PLUGIN_ARTIFACTS_STEP:-}" ]] ; then
  args+=("--step" "${BUILDKITE_PLUGIN_ARTIFACTS_STEP}")
fi

if [[ -n "${BUILDKITE_PLUGIN_ARTIFACTS_BUILD:-}" ]] ; then
  args+=("--build" "${BUILDKITE_PLUGIN_ARTIFACTS_BUILD}")
fi

paths=()
compress=()

COMPRESSED="false"
SINGULAR_DOWNLOAD_OBJECT="false"
RELOCATION="false"
MULTIPLE_DOWNLOADS="false"
IGNORE_ERRORS="${BUILDKITE_PLUGIN_ARTIFACTS_IGNORE_MISSING:-"false"}"

if [[ -n "${BUILDKITE_PLUGIN_ARTIFACTS_DOWNLOAD:-}" ]] || { [[ -n "${BUILDKITE_PLUGIN_ARTIFACTS_DOWNLOAD_FROM:-}" ]] && [[ -n "${BUILDKITE_PLUGIN_ARTIFACTS_DOWNLOAD_TO:-}" ]]; }; then
    SINGULAR_DOWNLOAD_OBJECT="true"
    if [[ -n "${BUILDKITE_PLUGIN_ARTIFACTS_DOWNLOAD:-}" ]] ; then
      paths+=("$BUILDKITE_PLUGIN_ARTIFACTS_DOWNLOAD")
    elif [[ -n "${BUILDKITE_PLUGIN_ARTIFACTS_DOWNLOAD_FROM:-}" ]] && [[ -n "${BUILDKITE_PLUGIN_ARTIFACTS_DOWNLOAD_TO:-}" ]] ; then
      RELOCATION="true"
      paths+=("$BUILDKITE_PLUGIN_ARTIFACTS_DOWNLOAD_FROM")
    fi
fi

while IFS='=' read -r path _ ; do
  if [[ $path =~ ^(BUILDKITE_PLUGIN_ARTIFACTS_DOWNLOAD_[0-9]+) ]] && ! [[ $path =~ ^(BUILDKITE_PLUGIN_ARTIFACTS_DOWNLOAD_[0-9]+_TO) ]]; then
    MULTIPLE_DOWNLOADS="true"
    paths+=("${!path}")
  fi
done < <(env | sort)

if [[ "${#paths[@]}" -le 0 ]]; then
  # no download data
  exit 0
fi

bk_agent() {
  if ! buildkite-agent artifact "${@}"; then
    if [[ "${BUILDKITE_PLUGIN_ARTIFACTS_IGNORE_MISSING:-"false"}" != "false" ]]; then
      echo "Ignoring error in download"
    else
      echo "Error in download"
      return 1
    fi
  fi

  return 0
}

handle_relocation() {
  local index="$1"
  local var_string=""
  if [[ -n "${index}" ]]; then
    var_string="${index}_"
  fi

  source_env_var="BUILDKITE_PLUGIN_ARTIFACTS_DOWNLOAD_${var_string}FROM"
  dest_env_var="BUILDKITE_PLUGIN_ARTIFACTS_DOWNLOAD_${var_string}TO"
  if [[ -n "${!dest_env_var:-}" ]]; then
    if ! [[ -d $(dirname "${!dest_env_var}") ]]; then
      mkdir -p "$(dirname "${!dest_env_var}")"
    fi

    if [[ ! -e "${!source_env_var}" ]] && [[ ${BUILDKITE_PLUGIN_ARTIFACTS_IGNORE_MISSING:-"false"} != "false" ]]; then
      echo "Ignoring missing file ${!source_env_var} for relocation"
    else
      echo "~~~ Moving [${!source_env_var}] to [${!dest_env_var}]..."
      mv "${!source_env_var}" "${!dest_env_var}"
    fi
  fi
}

if [[ -n "${BUILDKITE_PLUGIN_ARTIFACTS_COMPRESSED:-}" ]]; then
  COMPRESSED="true"
  if [[ "${BUILDKITE_PLUGIN_ARTIFACTS_COMPRESSED}" =~ .*\.zip ]]; then
    compress+=("unzip" "${BUILDKITE_PLUGIN_ARTIFACTS_COMPRESSED}")
  elif [[ "${BUILDKITE_PLUGIN_ARTIFACTS_COMPRESSED}" =~ .*\.tgz ]]; then
    compress+=("tar" "xzf" "${BUILDKITE_PLUGIN_ARTIFACTS_COMPRESSED}")
  else
    echo "+++ ðŸš¨ The inferred compression file format for the artifact is not currently supported"
    exit 1
  fi
fi

if [[ "${#args[@]}" -gt 1 ]]; then
  EXTRA_MESSAGE="(extra args: '${args[*]:1}')"
else
  EXTRA_MESSAGE=""
fi

workdir="${BUILDKITE_PLUGIN_ARTIFACTS_WORKDIR:-.}"

if [[ "${COMPRESSED}" == "true" ]]; then
  echo "~~~ Downloading artifacts ${EXTRA_MESSAGE}"
  bk_agent "${args[@]}" "${BUILDKITE_PLUGIN_ARTIFACTS_COMPRESSED}" "${workdir}"

  echo "~~~ Uncompressing ${paths[*]} from ${BUILDKITE_PLUGIN_ARTIFACTS_COMPRESSED}"
  "${compress[@]}" "${paths[@]}"

  # single relocation
  if [[ -n "${BUILDKITE_PLUGIN_ARTIFACTS_DOWNLOAD_TO:-}" ]]; then
    handle_relocation ""
  fi

  # multiple relocations
  index=0
  for path in "${paths[@]}"; do
    handle_relocation "${index}"
    ((index+=1))
  done

elif [[ "${SINGULAR_DOWNLOAD_OBJECT}" == "true" ]]; then
  if [[ "${RELOCATION}" == "true" ]]; then
    source="${BUILDKITE_PLUGIN_ARTIFACTS_DOWNLOAD_FROM}"
  else
    source="${paths[*]}"
  fi

  echo "~~~ Downloading artifacts ${EXTRA_MESSAGE}"
  bk_agent "${args[@]}" "${source}" "${workdir}"

  if [[ -n "${BUILDKITE_PLUGIN_ARTIFACTS_DOWNLOAD_TO:-}" ]]; then
    handle_relocation ""
  fi
elif [[ "${MULTIPLE_DOWNLOADS}" == "true" ]]; then
  index=0

  echo "~~~ Downloading artifacts ${EXTRA_MESSAGE}"
  for path in "${paths[@]}"; do
    source_env_var="BUILDKITE_PLUGIN_ARTIFACTS_DOWNLOAD_${index}_FROM"
    dest_env_var="BUILDKITE_PLUGIN_ARTIFACTS_DOWNLOAD_${index}_TO"
    if [[ -n "${!source_env_var:-}" ]] && [[ -n "${!dest_env_var:-}" ]]; then
      source="${!source_env_var}"
    else
      source="${path}"
    fi
    bk_agent "${args[@]}" "${source}" "${workdir}"
    handle_relocation "${index}"
    ((index+=1))
  done
fi

#!/bin/bash -x
set -euo pipefail

if [[ "${BUILDKITE_PLUGIN_ARTIFACTS_DEBUG:-false}" =~ (true|on|1) ]] ; then
  echo "--- :hammer: Enabling debug mode"
  set -x
fi

args=()

if [[ -n "${BUILDKITE_PLUGIN_ARTIFACTS_JOB:-}" ]] ; then
  args+=("--job" "${BUILDKITE_PLUGIN_ARTIFACTS_JOB}")
fi

paths=()

if [[ -n "${BUILDKITE_PLUGIN_ARTIFACTS_UPLOAD:-}" ]] ; then
  paths+=("$BUILDKITE_PLUGIN_ARTIFACTS_UPLOAD")
fi

while IFS='=' read -r path _ ; do
  if [[ $path =~ ^(BUILDKITE_PLUGIN_ARTIFACTS_UPLOAD_[0-9]+) ]] ; then
    paths+=("${!path}")
  fi
done < <(env | sort)

workdir=${BUILDKITE_PLUGIN_ARTIFACTS_WORKDIR:-.}

pushd "${workdir}"
trap popd EXIT

if [ "${#paths[@]}" -eq 1 ]; then
  if [[ "${paths[*]}" = *'->'* ]]; then
    IFS='|' read -r source dest <<< $(echo ${paths[*]} | awk '{split($0,a,"\\s?->\\s?"); print a[1]"|"a[2]}')
    if [ -f ${source} ]; then
      echo "Moving [${source}] to [${dest}]..."
      mv "${source}" "${dest}"
    fi
    path="${dest}"
  else
    path="${paths[*]}"
  fi

  if [ "${#args[@]}" -gt 0 ]; then
    echo "--- Uploading artifacts with args: ${args[*]}"

    buildkite-agent artifact upload "${args[@]}" "${path}"
  else
    echo "--- Uploading artifacts"

    buildkite-agent artifact upload "${path}"
  fi
elif [ "${#paths[@]}" -gt 1 ]; then
  if [ "${#args[@]}" -gt 0 ]; then
    echo "--- Uploading artifacts with args: ${args[*]}"

    for path in "${paths[@]}"
      do
        if [[ "${path}" = *'->'* ]]; then
          IFS='|' read -r source dest <<< $(echo ${path} | awk '{split($0,a,"\\s?->\\s?"); print a[1]"|"a[2]}')
          if [ -f ${source} ]; then
            echo "Moving [${source}] to [${dest}]..."
            mv "${source}" "${dest}"
          fi
          path="${dest}"
        fi
        buildkite-agent artifact upload "${args[@]}" "$path"
      done
  else
    echo "--- Uploading artifacts"

    for path in "${paths[@]}"
      do
        if [[ "${path}" = *'->'* ]]; then
          IFS='|' read -r source dest <<< $(echo ${path} | awk '{split($0,a,"\\s?->\\s?"); print a[1]"|"a[2]}')
          if [ -f ${source} ]; then
            echo "Moving [${source}] to [${dest}]..."
            mv "${source}" "${dest}"
          fi
          path="${dest}"
        fi
        buildkite-agent artifact upload "$path"
      done
  fi
fi